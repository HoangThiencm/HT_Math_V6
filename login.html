<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Nhập - Hỗ trợ dạy học</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', sans-serif;
        }
    </style>
</head>
<body class="p-4">

    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-200">
        <div class="text-center mb-8">
            <div class="inline-block p-3 rounded-full bg-blue-600 text-white mb-3">
                <i class="fas fa-robot text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800">Trợ Lý Dạy học</h2>
            <p class="text-slate-500 text-sm">Vui lòng đăng nhập để tiếp tục</p>
        </div>

        <!-- TABS -->
        <div class="flex mb-6 border-b border-gray-200">
            <button id="tabLogin" onclick="switchTab('login')" class="flex-1 py-2 text-blue-600 font-bold border-b-2 border-blue-600">Đăng Nhập</button>
            <button id="tabRegister" onclick="switchTab('register')" class="flex-1 py-2 text-slate-500 font-medium hover:text-blue-500">Đăng Ký</button>
        </div>

        <!-- FORM -->
        <form id="authForm" onsubmit="handleAuth(event)">
            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                <div class="relative">
                    <span class="absolute left-3 top-2.5 text-slate-400"><i class="fas fa-envelope"></i></span>
                    <input type="email" id="email" required class="pl-10 w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="email@example.com">
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-slate-700 mb-1">Mật khẩu</label>
                <div class="relative">
                    <span class="absolute left-3 top-2.5 text-slate-400"><i class="fas fa-lock"></i></span>
                    <input type="password" id="password" required class="pl-10 w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="••••••••">
                </div>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded shadow transition flex justify-center items-center">
                <span>Đăng Nhập</span>
            </button>
            
            <p id="message" class="text-center text-sm mt-4 text-red-500 hidden font-medium px-2 py-1 rounded"></p>
        </form>
    </div>

    <script>
        // === QUAN TRỌNG: Link Server ===
        const HF_API_URL = "https://hoangthiencm-ht-math-web-backend.hf.space/api"; 

        let isLoginMode = true;

        function switchTab(mode) {
            isLoginMode = (mode === 'login');
            const tabLogin = document.getElementById('tabLogin');
            const tabRegister = document.getElementById('tabRegister');
            const btnSpan = document.querySelector('#submitBtn span');
            const msg = document.getElementById('message');
            msg.classList.add('hidden'); 

            if(isLoginMode) {
                tabLogin.className = "flex-1 py-2 text-blue-600 font-bold border-b-2 border-blue-600";
                tabRegister.className = "flex-1 py-2 text-slate-500 font-medium hover:text-blue-500";
                if(btnSpan) btnSpan.textContent = "Đăng Nhập";
            } else {
                tabRegister.className = "flex-1 py-2 text-blue-600 font-bold border-b-2 border-blue-600";
                tabLogin.className = "flex-1 py-2 text-slate-500 font-medium hover:text-blue-500";
                if(btnSpan) btnSpan.textContent = "Đăng Ký Tài Khoản";
            }
        }

        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('message');
            const btn = document.getElementById('submitBtn');

            btn.disabled = true;
            btn.innerHTML = '<span><i class="fas fa-spinner fa-spin"></i> Đang xử lý...</span>';

            const endpoint = isLoginMode ? "/login" : "/register";
            
            try {
                // [FIX 422] SỬ DỤNG FORMDATA THAY VÌ JSON
                const formData = new FormData();
                formData.append('email', email);
                formData.append('password', password);

                const response = await fetch(`${HF_API_URL}${endpoint}`, {
                    method: 'POST',
                    // Không cần set 'Content-Type': 'multipart/form-data', fetch tự làm
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    if (isLoginMode) {
                        localStorage.setItem('authToken', data.token);
                        localStorage.setItem('userEmail', email);
                        window.location.href = 'index.html';
                    } else {
                        msg.textContent = "Đăng ký thành công! Vui lòng chờ Admin duyệt.";
                        msg.className = "text-center text-sm mt-4 text-yellow-600 bg-yellow-50 p-2 rounded block border border-yellow-200";
                        switchTab('login');
                    }
                } else {
                    throw new Error(data.detail || "Có lỗi xảy ra");
                }
            } catch (err) {
                msg.textContent = err.message;
                if(err.message.includes("chưa được kích hoạt")) {
                     msg.className = "text-center text-sm mt-4 text-yellow-700 bg-yellow-50 p-2 rounded block border border-yellow-200";
                } else {
                     msg.className = "text-center text-sm mt-4 text-red-500 block";
                }
            } finally {
                msg.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = isLoginMode ? '<span>Đăng Nhập</span>' : '<span>Đăng Ký Tài Khoản</span>';
            }
        }

        if(localStorage.getItem('authToken')) {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
