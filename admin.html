<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - HT MATH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f3f4f6; }
        .badge-pending { background-color: #fef3c7; color: #d97706; }
        .badge-active { background-color: #d1fae5; color: #059669; }
        .btn-action { transition: all 0.2s; }
        .btn-action:hover { transform: scale(1.05); }
    </style>
</head>
<body class="p-6">

    <div class="max-w-6xl mx-auto">
        <!-- HEADER -->
        <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-lg shadow-sm">
            <div class="flex items-center gap-3">
                <i class="fas fa-user-shield text-blue-600 text-3xl"></i>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Quản Trị Hệ Thống</h1>
                    <p class="text-xs text-gray-500">HT MATH WEB Admin Panel</p>
                </div>
            </div>
            
            <!-- ADMIN KEY INPUT -->
            <div class="flex items-center gap-2">
                <div class="relative">
                    <i class="fas fa-key absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                    <input type="password" id="admin-secret" value="admin123" 
                           class="pl-8 pr-3 py-2 border rounded text-sm focus:outline-none focus:border-blue-500 w-48" 
                           placeholder="Admin Secret Key">
                </div>
                <button onclick="fetchUsers()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-bold transition">
                    <i class="fas fa-sync-alt"></i> Tải lại
                </button>
            </div>
        </div>

        <!-- NOTIFICATION AREA -->
        <div id="status-msg" class="hidden mb-4 p-3 rounded text-sm font-medium"></div>

        <!-- USERS TABLE -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full leading-normal">
                <thead>
                    <tr>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Email / Tài khoản
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Ngày đăng ký
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Trạng thái
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Hành động
                        </th>
                    </tr>
                </thead>
                <tbody id="user-list">
                    <!-- Data will be loaded here -->
                    <tr>
                        <td colspan="4" class="px-5 py-8 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin mb-2 text-2xl"></i><br>Đang tải dữ liệu...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = "https://hoangthiencm-ht-math-web-backend.hf.space";

        // Hàm tiện ích: Lấy Secret Key từ ô nhập
        function getSecret() {
            return document.getElementById('admin-secret').value.trim();
        }

        // Hàm tiện ích: Hiển thị thông báo
        function showNotify(msg, type = 'success') {
            const el = document.getElementById('status-msg');
            el.className = `mb-4 p-3 rounded text-sm font-medium ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            el.innerHTML = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        // 1. LẤY DANH SÁCH USER
        async function fetchUsers() {
            const secret = getSecret();
            const tbody = document.getElementById('user-list');
            
            tbody.innerHTML = `<tr><td colspan="4" class="px-5 py-8 text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Đang tải...</td></tr>`;

            try {
                // Gửi secret qua Query Param cho GET request
                const response = await fetch(`${API_URL}/admin/users?secret=${encodeURIComponent(secret)}`);
                
                if (response.status === 403) throw new Error("Sai Secret Key (403 Forbidden)");
                if (!response.ok) throw new Error("Lỗi Server: " + response.status);

                const data = await response.json();
                renderTable(data.users || []);

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-5 py-8 text-center text-red-500"><i class="fas fa-exclamation-circle"></i> ${error.message}</td></tr>`;
            }
        }

        // Render bảng
        function renderTable(users) {
            const tbody = document.getElementById('user-list');
            if (users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-5 py-8 text-center text-gray-500">Chưa có người dùng nào.</td></tr>`;
                return;
            }

            tbody.innerHTML = users.map(user => {
                const statusBadge = user.status === 'active' 
                    ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full badge-active">Hoạt động</span>`
                    : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full badge-pending">Chờ duyệt</span>`;
                
                const approveBtn = user.status !== 'active' 
                    ? `<button onclick="approveUser('${user.email}')" class="btn-action bg-green-500 hover:bg-green-600 text-white p-1.5 rounded shadow text-xs mr-2" title="Duyệt"><i class="fas fa-check"></i></button>`
                    : '';

                return `
                    <tr>
                        <td class="px-5 py-4 border-b border-gray-200 bg-white text-sm">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">
                                    ${user.email.charAt(0).toUpperCase()}
                                </div>
                                <div class="ml-3">
                                    <p class="text-gray-900 whitespace-no-wrap font-medium">${user.email}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-5 py-4 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">${user.created_at || 'N/A'}</p>
                        </td>
                        <td class="px-5 py-4 border-b border-gray-200 bg-white text-sm">
                            ${statusBadge}
                        </td>
                        <td class="px-5 py-4 border-b border-gray-200 bg-white text-sm text-right">
                            ${approveBtn}
                            <button onclick="deleteUser('${user.email}')" class="btn-action bg-red-500 hover:bg-red-600 text-white p-1.5 rounded shadow text-xs" title="Xóa"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 2. DUYỆT USER
        async function approveUser(email) {
            if (!confirm(`Duyệt tài khoản ${email}?`)) return;
            
            const secret = getSecret();
            const formData = new FormData();
            formData.append('email', email);
            formData.append('secret', secret); // Gửi secret qua Form Data cho POST

            try {
                const response = await fetch(`${API_URL}/admin/approve-user`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error("Lỗi khi duyệt (Check Key)");
                
                showNotify(`Đã duyệt: ${email}`);
                fetchUsers(); // Refresh lại bảng

            } catch (error) {
                alert(error.message);
            }
        }

        // 3. XÓA USER
        async function deleteUser(email) {
            if (!confirm(`CẢNH BÁO: Bạn có chắc muốn xóa vĩnh viễn ${email}?`)) return;

            const secret = getSecret();
            const formData = new FormData();
            formData.append('email', email);
            formData.append('secret', secret);

            try {
                const response = await fetch(`${API_URL}/admin/delete-user`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error("Lỗi khi xóa (Check Key)");

                showNotify(`Đã xóa: ${email}`, 'error');
                fetchUsers();

            } catch (error) {
                alert(error.message);
            }
        }

        // Auto load on start
        document.addEventListener('DOMContentLoaded', fetchUsers);
    </script>
</body>
</html>
