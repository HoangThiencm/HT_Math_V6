<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Quản Lý User</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-slate-100 p-6 font-sans text-slate-800">

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800"><i class="fas fa-user-shield text-blue-600 mr-2"></i> Quản Trị Hệ Thống</h1>
                <div class="flex items-center gap-2 mt-2 text-sm">
                    <span class="text-slate-500">Server Status:</span>
                    <span id="serverStatus" class="flex items-center gap-1 font-bold text-orange-500">
                        <i class="fas fa-circle text-[8px] blink"></i> Đang kiểm tra...
                    </span>
                </div>
            </div>
            <a href="index.html" class="bg-white border border-slate-300 text-slate-700 hover:text-blue-600 hover:border-blue-500 px-4 py-2 rounded-lg font-medium transition-all shadow-sm">
                <i class="fas fa-home mr-1"></i> Trang chủ
            </a>
        </div>

        <!-- KHU VỰC ĐĂNG NHẬP -->
        <div id="loginSection" class="bg-white p-8 rounded-xl shadow-lg mb-6 max-w-md mx-auto border border-slate-200">
            <h2 class="text-xl font-bold text-slate-700 mb-4 text-center">Đăng nhập Quản trị</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">Admin Key</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-slate-400"><i class="fas fa-key"></i></span>
                        <input type="password" id="adminKey" class="w-full pl-10 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nhập key...">
                    </div>
                </div>
                <button onclick="loadUsers()" id="btnLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-md transition-all flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="btnText">Truy cập Dashboard</span>
                </button>
                <p id="loginError" class="text-red-500 text-sm text-center hidden bg-red-50 p-2 rounded border border-red-100"></p>
            </div>
        </div>

        <!-- KHU VỰC DASHBOARD (Ẩn mặc định) -->
        <div id="dashboardSection" class="hidden animate-fade-in-up">
            
            <!-- Thống kê nhanh -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-500">
                    <div class="text-slate-400 text-xs font-bold uppercase">Tổng User</div>
                    <div class="text-2xl font-bold text-slate-700" id="statTotal">0</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-yellow-500">
                    <div class="text-slate-400 text-xs font-bold uppercase">Chờ duyệt</div>
                    <div class="text-2xl font-bold text-yellow-600" id="statPending">0</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-500">
                    <div class="text-slate-400 text-xs font-bold uppercase">Hoạt động</div>
                    <div class="text-2xl font-bold text-green-600" id="statActive">0</div>
                </div>
            </div>

            <!-- Bảng dữ liệu -->
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                    <h3 class="font-bold text-slate-700">Danh sách tài khoản</h3>
                    <div class="flex gap-2">
                        <button onclick="loadUsers()" class="bg-white border hover:border-blue-500 text-slate-600 hover:text-blue-600 px-3 py-1 rounded text-sm transition">
                            <i class="fas fa-sync-alt"></i> Reload
                        </button>
                        <button onclick="logoutAdmin()" class="bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 px-3 py-1 rounded text-sm transition">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Ngày tạo</th>
                                <th class="px-6 py-3 text-center text-xs font-bold text-slate-500 uppercase">Trạng thái</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-slate-200">
                            <!-- Data rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- DEBUG LOG (Luôn hiện để theo dõi kết nối) -->
        <div class="mt-8 border-t pt-4">
            <button onclick="toggleDebug()" class="text-xs text-slate-400 hover:text-slate-600 underline mb-2">
                <i class="fas fa-terminal"></i> Hiện/Ẩn System Logs
            </button>
            <div id="debugContainer" class="hidden">
                <div class="bg-slate-900 text-green-400 p-4 rounded-lg font-mono text-xs h-40 overflow-y-auto border border-slate-700 shadow-inner">
                    <pre id="debugOutput">System initialized...</pre>
                </div>
            </div>
        </div>

    </div>

    <script>
        // CẤU HÌNH SERVER
        const SERVER_URL = "https://hoangthiencm-ht-math-web-backend.hf.space";
        
        // Trạng thái
        const els = {
            key: document.getElementById('adminKey'),
            btn: document.getElementById('btnLogin'),
            btnText: document.getElementById('btnText'),
            error: document.getElementById('loginError'),
            status: document.getElementById('serverStatus'),
            table: document.getElementById('tableBody'),
            dash: document.getElementById('dashboardSection'),
            login: document.getElementById('loginSection')
        };

        // Init
        if(localStorage.getItem('adminKey')) els.key.value = localStorage.getItem('adminKey');
        checkServerHealth();

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            const el = document.getElementById('debugOutput');
            el.textContent += `\n[${time}] ${msg}`;
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }

        function toggleDebug() {
            document.getElementById('debugContainer').classList.toggle('hidden');
        }

        // Kiểm tra Server có sống không
        async function checkServerHealth() {
            log("Pinging server...");
            els.status.innerHTML = '<i class="fas fa-circle text-[8px] blink"></i> Connecting...';
            try {
                // Gọi thử endpoint nhẹ nhất hoặc root để đánh thức server
                const res = await fetch(SERVER_URL + "/"); 
                if(res.ok) {
                    els.status.innerHTML = '<i class="fas fa-circle text-[8px] text-green-500"></i> Online';
                    els.status.className = "flex items-center gap-1 font-bold text-green-600";
                    log("Server Online!");
                } else {
                    throw new Error(res.status);
                }
            } catch (e) {
                els.status.innerHTML = '<i class="fas fa-exclamation-circle"></i> Sleeping/Error';
                els.status.className = "flex items-center gap-1 font-bold text-orange-500";
                log("Server check failed (Normal if sleeping): " + e.message);
            }
        }

        async function loadUsers() {
            const key = els.key.value.trim();
            if(!key) return showError("Vui lòng nhập Admin Key!");

            setLoading(true);
            showError(""); // Clear error

            try {
                log(`Fetching users from: ${SERVER_URL}/admin/users`);
                
                // Set timeout 15s để tránh treo nếu server đang wake up
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);

                const res = await fetch(`${SERVER_URL}/admin/users`, {
                    headers: { 'key': key },
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if(!res.ok) {
                    if(res.status === 401) throw new Error("Sai Admin Key!");
                    else if(res.status === 404) throw new Error("API Route không tồn tại (/admin/users).");
                    else throw new Error(`Lỗi Server: ${res.status}`);
                }

                let data = await res.json();
                log("Data received: " + JSON.stringify(data).substring(0, 100) + "...");

                // Normalization dữ liệu
                let users = [];
                if(Array.isArray(data)) users = data;
                else if(data.users) users = data.users;
                else if(data.data) users = data.data;

                // Lưu key
                localStorage.setItem('adminKey', key);
                
                // Render
                updateDashboard(users, key);

                // Switch View
                els.login.classList.add('hidden');
                els.dash.classList.remove('hidden');
                els.status.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
                els.status.className = "flex items-center gap-1 font-bold text-green-600";

            } catch (e) {
                log("Error: " + e.message);
                if (e.name === 'AbortError') {
                    showError("Kết nối quá lâu! Server đang khởi động, vui lòng thử lại sau 30 giây.");
                } else {
                    showError(e.message);
                }
            } finally {
                setLoading(false);
            }
        }

        function updateDashboard(users, key) {
            // Stats
            document.getElementById('statTotal').textContent = users.length;
            document.getElementById('statPending').textContent = users.filter(u => u.status === 'pending').length;
            document.getElementById('statActive').textContent = users.filter(u => u.status === 'active').length;

            // Table
            els.table.innerHTML = '';
            if(users.length === 0) {
                els.table.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-slate-400">
                    <i class="fas fa-database text-3xl mb-2"></i><br>
                    Không có dữ liệu.<br>
                    <span class="text-xs text-red-400">Nếu bạn chắc chắn có User, hãy chạy lệnh SQL Trigger trong Supabase!</span>
                </td></tr>`;
                return;
            }

            users.forEach(u => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition";
                
                const isPending = u.status === 'pending';
                const dateStr = u.created_at ? new Date(u.created_at).toLocaleDateString('vi-VN') : '-';
                
                let badge = isPending 
                    ? `<span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded-full border border-yellow-200">Chờ duyệt</span>`
                    : `<span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded-full border border-green-200">Hoạt động</span>`;

                let actions = isPending
                    ? `<button onclick="actionUser('${u.email}', 'approve', '${key}')" class="text-green-600 hover:bg-green-100 px-2 py-1 rounded font-bold text-xs mr-2 border border-green-200">Duyệt</button>
                       <button onclick="actionUser('${u.email}', 'delete', '${key}')" class="text-red-600 hover:bg-red-100 px-2 py-1 rounded font-bold text-xs border border-red-200">Xóa</button>`
                    : `<button onclick="actionUser('${u.email}', 'delete', '${key}')" class="text-slate-400 hover:text-red-600 text-xs px-2"><i class="fas fa-trash"></i></button>`;

                tr.innerHTML = `
                    <td class="px-6 py-4 text-sm font-medium text-slate-700">${u.email}</td>
                    <td class="px-6 py-4 text-sm text-slate-500">${dateStr}</td>
                    <td class="px-6 py-4 text-center">${badge}</td>
                    <td class="px-6 py-4 text-right">${actions}</td>
                `;
                els.table.appendChild(tr);
            });
        }

        async function actionUser(email, action, key) {
            if(!confirm(`Bạn chắc chắn muốn ${action} ${email}?`)) return;
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const res = await fetch(`${SERVER_URL}/admin/${action}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, admin_key: key })
                });

                if(res.ok) {
                    loadUsers(); // Reload list
                } else {
                    alert("Thao tác thất bại!");
                }
            } catch(e) {
                alert("Lỗi kết nối: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function logoutAdmin() {
            localStorage.removeItem('adminKey');
            location.reload();
        }

        function setLoading(isLoading) {
            if(isLoading) {
                els.btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang kết nối...';
                els.btn.disabled = true;
                els.key.disabled = true;
                document.body.style.cursor = 'wait';
            } else {
                els.btn.innerHTML = '<span id="btnText">Truy cập Dashboard</span>';
                els.btn.disabled = false;
                els.key.disabled = false;
                document.body.style.cursor = 'default';
            }
        }

        function showError(msg) {
            els.error.textContent = msg;
            if(msg) els.error.classList.remove('hidden');
            else els.error.classList.add('hidden');
        }
    </script>
</body>
</html>
