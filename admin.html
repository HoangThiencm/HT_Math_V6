<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Quản Lý Người Dùng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 p-6 font-sans">

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800"><i class="fas fa-user-shield text-blue-600 mr-2"></i> Quản Trị Hệ Thống</h1>
                <p class="text-slate-500 text-sm mt-1">
                    Server đang kết nối: <span id="serverUrlDisplay" class="font-mono text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded">...</span>
                </p>
            </div>
            <a href="index.html" class="bg-white border border-slate-300 text-slate-700 hover:text-blue-600 hover:border-blue-500 px-4 py-2 rounded-lg font-medium transition-all shadow-sm">
                <i class="fas fa-home mr-1"></i> Về Trang chủ
            </a>
        </div>

        <!-- KHU VỰC ĐĂNG NHẬP ADMIN -->
        <div id="loginSection" class="bg-white p-8 rounded-xl shadow-lg mb-6 max-w-md mx-auto border border-slate-200">
            <h2 class="text-xl font-bold text-slate-700 mb-4 text-center">Đăng nhập Quản trị viên</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">Mã bảo mật (Secret Key)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-slate-400"><i class="fas fa-key"></i></span>
                        <input type="password" id="adminKey" class="w-full pl-10 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Nhập Admin Key...">
                    </div>
                </div>
                <button onclick="loadUsers()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-md transition-all transform active:scale-95 flex justify-center items-center gap-2">
                    <span id="btnText">Truy cập Dashboard</span>
                    <i id="btnIcon" class="fas fa-arrow-right"></i>
                </button>
                <p id="loginError" class="text-red-500 text-sm text-center hidden"></p>
            </div>
        </div>

        <!-- KHU VỰC DASHBOARD (ẨN KHI CHƯA ĐĂNG NHẬP) -->
        <div id="dashboardSection" class="hidden animate-fade-in-up">
            
            <!-- 1. THỐNG KÊ (STATISTICS) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Card Tổng -->
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500 flex justify-between items-center">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Tổng người dùng</p>
                        <h3 id="statTotal" class="text-3xl font-bold text-slate-800 mt-1">0</h3>
                    </div>
                    <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center text-blue-600 text-xl">
                        <i class="fas fa-users"></i>
                    </div>
                </div>

                <!-- Card Chờ duyệt -->
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-yellow-500 flex justify-between items-center">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Chờ duyệt</p>
                        <h3 id="statPending" class="text-3xl font-bold text-yellow-600 mt-1">0</h3>
                    </div>
                    <div class="bg-yellow-100 w-12 h-12 rounded-full flex items-center justify-center text-yellow-600 text-xl">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>

                <!-- Card Hoạt động -->
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500 flex justify-between items-center">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Đang hoạt động</p>
                        <h3 id="statActive" class="text-3xl font-bold text-green-600 mt-1">0</h3>
                    </div>
                    <div class="bg-green-100 w-12 h-12 rounded-full flex items-center justify-center text-green-600 text-xl">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
            </div>

            <!-- 2. DANH SÁCH CHI TIẾT -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
                <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex flex-col md:flex-row justify-between items-center gap-4">
                    <h3 class="font-bold text-slate-700 text-lg">Danh sách tài khoản</h3>
                    <div class="flex gap-2">
                        <button onclick="loadUsers()" class="bg-white border border-slate-300 text-slate-600 hover:text-blue-600 hover:border-blue-500 px-3 py-1.5 rounded-lg text-sm font-medium transition shadow-sm">
                            <i class="fas fa-sync-alt mr-1"></i> Làm mới
                        </button>
                        <button onclick="logoutAdmin()" class="bg-red-50 border border-red-200 text-red-600 hover:bg-red-100 px-3 py-1.5 rounded-lg text-sm font-medium transition shadow-sm">
                            <i class="fas fa-sign-out-alt mr-1"></i> Thoát
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Email đăng ký</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Ngày tạo</th>
                                <th class="px-6 py-3 text-center text-xs font-bold text-slate-500 uppercase tracking-wider">Trạng thái</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-slate-200">
                            <!-- Dữ liệu sẽ đổ vào đây -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- KHU VỰC DEBUG LOG -->
        <div class="mt-8">
            <h3 class="font-bold text-slate-700 mb-2">
                <i class="fas fa-bug text-red-500 mr-2"></i>Debug Log 
                <span class="text-xs font-normal text-slate-500">(Chụp màn hình phần này gửi Admin nếu lỗi)</span>
            </h3>
            <div class="bg-slate-900 text-green-400 p-4 rounded-lg shadow-inner font-mono text-xs overflow-x-auto h-64 overflow-y-scroll border border-slate-700">
                <pre id="debugOutput" class="whitespace-pre-wrap">Waiting for action...</pre>
            </div>
        </div>

    </div>

    <script>
        // === CẬP NHẬT: Link Server CHÍNH XÁC của bạn ===
        const HF_API_URL = "https://hoangthiencm-ht-math-web-backend.hf.space"; 

        // Hiển thị URL để debug
        document.getElementById('serverUrlDisplay').textContent = HF_API_URL;

        // Tự động điền key nếu đã lưu
        if(localStorage.getItem('adminKey')) {
            document.getElementById('adminKey').value = localStorage.getItem('adminKey');
        }

        // HÀM DEBUG LOG RA MÀN HÌNH
        function log(msg, data = null) {
            const debugEl = document.getElementById('debugOutput');
            const time = new Date().toLocaleTimeString();
            let text = `[${time}] ${msg}`;
            if (data !== null) {
                try {
                    if (typeof data === 'object') {
                        text += '\n' + JSON.stringify(data, null, 2);
                    } else {
                        text += '\n' + String(data);
                    }
                } catch (e) {
                    text += '\n[Cannot stringify data]';
                }
            }
            debugEl.textContent += '\n--------------------------------\n' + text;
            debugEl.scrollTop = debugEl.scrollHeight;
            console.log(msg, data);
        }

        async function loadUsers() {
            const keyInput = document.getElementById('adminKey');
            const key = keyInput.value.trim();
            const btnText = document.getElementById('btnText');
            const btnIcon = document.getElementById('btnIcon');
            const errorMsg = document.getElementById('loginError');

            log("Bắt đầu loadUsers()...");

            if(!key) {
                log("Lỗi: Chưa nhập Admin Key");
                errorMsg.textContent = "Vui lòng nhập Admin Key!";
                errorMsg.classList.remove('hidden');
                return;
            }

            // Hiệu ứng loading
            btnText.textContent = "Đang kết nối...";
            btnIcon.className = "fas fa-spinner fa-spin";
            errorMsg.classList.add('hidden');
            document.body.style.cursor = 'wait';

            try {
                const url = `${HF_API_URL}/admin/users`;
                log(`Đang gọi API: ${url}`);
                log(`Headers Key: ${key.substring(0,3)}***`);

                // Endpoint: /admin/users
                const res = await fetch(url, {
                    headers: { 'key': key }
                });

                log(`Trạng thái phản hồi: ${res.status} ${res.statusText}`);

                if(!res.ok) {
                    const text = await res.text();
                    log(`Lỗi Server trả về: ${text}`);
                    if(res.status === 401) throw new Error("Sai Admin Key! Vui lòng kiểm tra lại.");
                    else throw new Error(`Lỗi kết nối Server (${res.status}): ${text}`);
                }
                
                // Đọc raw text trước để debug
                const rawText = await res.text();
                log("Raw Body nhận được:", rawText);

                let rawData;
                try {
                    rawData = JSON.parse(rawText);
                    log("Đã parse JSON thành công:", rawData);
                } catch (e) {
                    log("Lỗi parse JSON:", e.message);
                    throw new Error("Server trả về dữ liệu không phải JSON hợp lệ.");
                }

                // XỬ LÝ DỮ LIỆU THÔNG MINH
                let users = [];
                if (Array.isArray(rawData)) {
                    users = rawData;
                    log("Dữ liệu là mảng trực tiếp (Array)");
                } else if (rawData.users && Array.isArray(rawData.users)) {
                    users = rawData.users;
                    log("Dữ liệu nằm trong key 'users'");
                } else if (rawData.data && Array.isArray(rawData.data)) {
                    users = rawData.data;
                    log("Dữ liệu nằm trong key 'data'");
                } else {
                    log("CẢNH BÁO: Không tìm thấy mảng user nào trong dữ liệu!");
                    // Fallback: tìm thử bất kỳ mảng nào
                    const potentialArray = Object.values(rawData).find(val => Array.isArray(val));
                    if (potentialArray) {
                        users = potentialArray;
                        log("Đã tìm thấy một mảng khác để hiển thị:", users);
                    }
                }
                
                log(`Số lượng users tìm thấy: ${users.length}`);

                // Lưu key lại
                localStorage.setItem('adminKey', key);
                
                updateStats(users);
                renderTable(users, key);
                
                // Chuyển giao diện
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');

            } catch (e) {
                log("NGOẠI LỆ (EXCEPTION):", e.message);
                console.error(e);
                errorMsg.textContent = e.message;
                errorMsg.classList.remove('hidden');
            } finally {
                // Reset nút
                btnText.textContent = "Truy cập Dashboard";
                btnIcon.className = "fas fa-arrow-right";
                document.body.style.cursor = 'default';
            }
        }

        function updateStats(users) {
            const total = users.length;
            const pending = users.filter(u => u.status === 'pending').length;
            const active = users.filter(u => u.status === 'active').length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPending').textContent = pending;
            document.getElementById('statActive').textContent = active;
        }

        function renderTable(users, key) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            // Cập nhật thông báo Empty State chi tiết hơn
            if(!users || users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center text-slate-400 italic">
                            <div class="flex flex-col items-center justify-center">
                                <i class="fas fa-inbox text-4xl mb-3 text-slate-300"></i>
                                <span class="text-lg font-medium text-slate-500">Danh sách trống (0 Users)</span>
                                <div class="mt-2 text-sm text-slate-400 max-w-md bg-slate-50 p-3 rounded border border-slate-200">
                                    <p class="font-bold text-red-400 mb-1"><i class="fas fa-exclamation-triangle"></i> Tại sao tôi có data mà list lại trống?</p>
                                    <ul class="list-disc text-left pl-5 space-y-1">
                                        <li>Backend có thể đang đọc bảng <code>public.users</code> nhưng user lại nằm ở <code>auth.users</code>.</li>
                                        <li>Backend đang kết nối sai Database (Ví dụ: kết nối Local thay vì Supabase Cloud).</li>
                                        <li>Logic truy vấn của Backend đang lọc bỏ user (VD: chỉ hiện user 'active').</li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            users.forEach(user => {
                const isPending = user.status === 'pending';
                const createdDate = user.created_at ? new Date(user.created_at).toLocaleDateString('vi-VN') : '---';
                
                const statusBadge = isPending 
                    ? '<span class="px-3 py-1 inline-flex text-xs leading-5 font-bold rounded-full bg-yellow-100 text-yellow-800 border border-yellow-200 shadow-sm"><i class="fas fa-hourglass-half mr-1"></i> Chờ duyệt</span>'
                    : '<span class="px-3 py-1 inline-flex text-xs leading-5 font-bold rounded-full bg-green-100 text-green-800 border border-green-200 shadow-sm"><i class="fas fa-check mr-1"></i> Hoạt động</span>';
                
                const actionBtns = isPending 
                    ? `<button onclick="approveUser('${user.email}', '${key}')" class="text-white bg-green-600 hover:bg-green-700 px-3 py-1.5 rounded text-xs font-bold shadow hover:shadow-md transition mr-2">
                        <i class="fas fa-check"></i> Duyệt
                       </button>
                       <button onclick="deleteUser('${user.email}', '${key}')" class="text-red-600 hover:bg-red-50 border border-red-200 px-3 py-1.5 rounded text-xs font-bold shadow-sm transition">
                        <i class="fas fa-times"></i> Từ chối
                       </button>` 
                    : `<button onclick="deleteUser('${user.email}', '${key}')" class="text-slate-500 hover:text-red-600 hover:bg-red-50 px-3 py-1.5 rounded text-xs font-bold transition">
                        <i class="fas fa-trash-alt"></i> Xóa
                       </button>`;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors group";
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-700">
                        <div class="flex items-center">
                            <div class="h-8 w-8 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center mr-3 group-hover:bg-blue-100 group-hover:text-blue-600 transition">
                                <i class="fas fa-user"></i>
                            </div>
                            ${user.email}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${createdDate}</td>
                    <td class="px-6 py-4 whitespace
