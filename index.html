<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HT MATH WEB - Chuyển Đổi PDF/Ảnh sang Word</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked.js for Markdown Preview -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- MathJax for LaTeX -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; }
        .hidden { display: none; }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .preview-content {
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
        }
        .preview-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1rem;
        }
        .preview-content th, .preview-content td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        .preview-content th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #f2f2f2;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <!-- LOGIN FORM -->
    <div id="login-container" class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
        <div class="text-center mb-6">
            <i class="fas fa-cube text-blue-600 text-4xl mb-2"></i>
            <h2 class="text-2xl font-bold text-gray-800">HT MATH WEB</h2>
            <p class="text-gray-500 text-sm">Đăng nhập để sử dụng công cụ</p>
        </div>
        
        <div id="login-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 text-sm"></div>
        
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
            <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Email của bạn">
        </div>
        
        <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2">Mật khẩu</label>
            <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="*********">
        </div>
        
        <button onclick="handleLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-200">
            Đăng Nhập
        </button>
    </div>

    <!-- MAIN APP DASHBOARD -->
    <!-- Đã mở rộng max-w để chứa đủ 3 cột -->
    <div id="app-container" class="hidden w-full px-4 min-h-screen flex flex-col">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4 flex justify-between items-center mt-4">
            <div class="flex items-center gap-3">
                <i class="fas fa-cube text-blue-600 text-2xl"></i>
                <h1 class="text-xl font-bold text-gray-800">HT MATH WEB <span class="text-xs font-normal text-gray-500 ml-2">v6.7 (Real Equation Word)</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <p id="user-display" class="font-medium text-gray-700 text-sm"></p>
                    <p class="text-xs text-green-600"><i class="fas fa-circle text-[8px]"></i> Online</p>
                </div>
                <button onclick="handleLogout()" class="bg-red-50 text-red-600 hover:bg-red-100 px-3 py-1.5 rounded text-sm font-medium transition">
                    <i class="fas fa-sign-out-alt"></i> Thoát
                </button>
            </div>
        </div>

        <!-- Main Content Grid: 3 Columns -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 flex-grow pb-4">
            
            <!-- CỘT 1: INPUT & SETTINGS -->
            <div class="bg-white rounded-lg shadow-lg p-6 flex flex-col h-full">
                <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                    <i class="fas fa-file-import text-blue-500"></i> Tải file lên
                </h3>
                
                <!-- File Drop Zone -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition cursor-pointer bg-gray-50 flex-grow flex flex-col justify-center items-center max-h-60" id="drop-zone" onclick="document.getElementById('file-upload').click()">
                    <input type="file" id="file-upload" class="hidden" accept=".pdf,.png,.jpg,.jpeg">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600 font-medium">Click hoặc kéo thả file</p>
                    <p class="text-xs text-gray-400 mt-1">PDF, PNG, JPG</p>
                    <div id="file-name" class="mt-3 text-sm font-semibold text-blue-600 hidden truncate w-full px-2"></div>
                </div>

                <!-- Settings -->
                <div class="mt-6 space-y-4">
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-1">Mô hình AI</label>
                        <select id="model-select" class="w-full border rounded p-2 text-sm bg-white focus:outline-none focus:border-blue-500">
                            <option value="gemini-2.5-flash">Đang tải...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-1">Chế độ</label>
                        <select id="mode-select" class="w-full border rounded p-2 text-sm bg-white focus:outline-none focus:border-blue-500">
                            <option value="latex">Toán học (Latex $...$)</option>
                            <option value="text">Văn bản thường</option>
                        </select>
                    </div>
                    
                    <button id="convert-btn" onclick="handleConvert()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded shadow transition duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-bolt"></i> Chuyển đổi
                    </button>
                    <div id="loading" class="hidden text-center py-2">
                        <div class="loading-spinner mb-2"></div>
                        <p class="text-xs text-gray-500">Đang xử lý...</p>
                    </div>
                </div>
            </div>

            <!-- CỘT 2: RAW MARKDOWN (AI OUTPUT) -->
            <div class="bg-white rounded-lg shadow-lg p-6 flex flex-col h-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-code text-orange-500"></i> Mã nguồn (AI)
                    </h3>
                    <button id="copy-btn" onclick="copyToClipboard()" class="hidden bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded text-xs font-bold transition">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
                <div class="relative flex-grow border rounded bg-gray-900 overflow-hidden">
                    <textarea id="result-text" class="w-full h-full p-4 font-mono text-sm resize-none focus:outline-none bg-gray-900 text-green-400" placeholder="Mã nguồn Markdown sẽ hiện ở đây... (Có thể chỉnh sửa trực tiếp)"></textarea>
                </div>
            </div>

            <!-- CỘT 3: RENDER PREVIEW & EXPORT -->
            <div class="bg-white rounded-lg shadow-lg p-6 flex flex-col h-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-eye text-green-500"></i> Xem trước
                    </h3>
                    <button id="download-btn" onclick="handleDownloadDocx()" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs font-bold transition shadow">
                        <i class="fas fa-file-word"></i> Tải Word (Eq)
                    </button>
                </div>
                <div class="relative flex-grow border rounded bg-white overflow-hidden">
                    <div id="result-preview" class="w-full h-full p-6 overflow-y-auto preview-content bg-white" 
                         style="min-height: 200px;"
                         ondrop="handleDrop(event)" 
                         ondragover="handleDragOver(event)"
                         onpaste="handlePaste(event)">
                        <div class="text-center text-gray-400 mt-20" id="preview-placeholder">
                            <i class="fas fa-file-alt text-4xl mb-3 opacity-20"></i>
                            <p>Kết quả hiển thị</p>
                            <p class="text-xs mt-2 text-gray-300">(Có thể dán ảnh trực tiếp vào đây)</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        
        <!-- Status Log -->
        <div id="status-log" class="mt-auto mb-4 text-xs text-gray-400 font-mono h-16 overflow-y-auto bg-gray-900 p-2 rounded mx-1">
            > System ready...<br>
        </div>
    </div>

    <!-- MODAL CẢNH BÁO OUT -->
    <div id="logout-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-sm text-center">
            <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
            <h3 class="text-lg font-bold mb-2">Phiên đăng nhập hết hạn</h3>
            <p class="text-gray-600 mb-4 text-sm">Tài khoản của bạn đã được đăng nhập trên một thiết bị khác.</p>
            <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">
                Đăng nhập lại
            </button>
        </div>
    </div>

    <script>
        // --- CẤU HÌNH API ---
        const API_URL = "https://hoangthiencm-ht-math-web-backend.hf.space";

        // --- GLOBAL VARIABLES ---
        let checkSessionInterval = null;
        let currentMarkdown = "";

        // --- UTILS ---
        function log(msg) {
            const el = document.getElementById('status-log');
            if(el) {
                const time = new Date().toLocaleTimeString();
                el.innerHTML += `> [${time}] ${msg}<br>`;
                el.scrollTop = el.scrollHeight;
            }
            console.log(msg);
        }

        function showError(msg) {
            const el = document.getElementById('login-error');
            if(el) {
                el.innerText = msg;
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('hidden'), 5000);
            } else {
                alert(msg);
            }
        }

        // --- AUTH LOGIC ---

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken');
            const email = localStorage.getItem('userEmail');

            const fileInput = document.getElementById('file-upload');
            if(fileInput) {
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        document.getElementById('file-name').innerText = file.name;
                        document.getElementById('file-name').classList.remove('hidden');
                    }
                });
            }

            if (token && email) {
                showApp(email);
                startSessionCheck();
            } else {
                showLogin();
            }
        });

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.querySelector('#login-container button');

            if (!email || !password) return showError("Vui lòng nhập đầy đủ thông tin");

            btn.innerText = "Đang xử lý...";
            btn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('email', email);
                formData.append('password', password);

                const response = await fetch(`${API_URL}/api/login`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || "Đăng nhập thất bại");
                }

                localStorage.setItem('authToken', data.token);
                localStorage.setItem('userEmail', data.email);

                log("Đăng nhập thành công.");
                showApp(data.email);
                startSessionCheck();

            } catch (err) {
                showError(err.message);
            } finally {
                btn.innerText = "Đăng Nhập";
                btn.disabled = false;
            }
        }

        async function handleLogout() {
            const email = localStorage.getItem('userEmail');
            if (email) {
                try {
                    await fetch(`${API_URL}/api/logout`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                } catch (e) { console.error(e); }
            }
            forceLogout();
        }

        function startSessionCheck() {
            if (checkSessionInterval) clearInterval(checkSessionInterval);
            
            checkSessionInterval = setInterval(async () => {
                const token = localStorage.getItem('authToken');
                const email = localStorage.getItem('userEmail');

                if (!token || !email) {
                    forceLogout();
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.append('email', email);
                    formData.append('token', token);

                    const response = await fetch(`${API_URL}/api/check-session`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.status === 401) {
                        log("Session invalid (401). Logout.");
                        forceLogout(true);
                    }

                } catch (error) {
                    console.log("Heartbeat error: " + error.message);
                }
            }, 10000); 
        }

        function forceLogout(showModal = false) {
            if (checkSessionInterval) clearInterval(checkSessionInterval);
            localStorage.removeItem('authToken');
            localStorage.removeItem('userEmail');
            
            if (showModal) {
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('logout-modal').classList.remove('hidden');
            } else {
                showLogin();
            }
        }

        // --- NEW: FETCH MODELS ---
        async function fetchModels() {
            const select = document.getElementById('model-select');
            try {
                const response = await fetch(`${API_URL}/api/models`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.models && Array.isArray(data.models)) {
                        select.innerHTML = "";
                        data.models.forEach(model => {
                            const opt = document.createElement('option');
                            opt.value = model;
                            opt.text = model.toUpperCase();
                            select.appendChild(opt);
                        });
                        log("Đã tải danh sách Models từ server.");
                        return;
                    }
                }
            } catch (e) {
                console.error("Lỗi fetch models:", e);
                log("Không thể tải Models, dùng mặc định.");
            }
            select.innerHTML = `
                <option value="gemini-2.5-flash">GEMINI-2.5-FLASH (Default)</option>
                <option value="gemini-1.5-pro">GEMINI-1.5-PRO</option>
            `;
        }

        function showApp(email) {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-display').innerText = email;
            document.getElementById('login-error').classList.add('hidden');
            document.body.classList.remove('items-center', 'justify-center');
            document.body.classList.add('items-start');
            
            fetchModels();
        }

        function showLogin() {
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('login-container').classList.remove('hidden');
            document.getElementById('logout-modal').classList.add('hidden');
            document.body.classList.add('items-center', 'justify-center');
            document.body.classList.remove('items-start');
        }

        // --- CONVERT LOGIC ---

        async function handleConvert() {
            const fileInput = document.getElementById('file-upload');
            const modelSelect = document.getElementById('model-select');
            const modeSelect = document.getElementById('mode-select');
            const btn = document.getElementById('convert-btn');
            const loading = document.getElementById('loading');

            if (!fileInput.files[0]) {
                alert("Vui lòng chọn file trước!");
                return;
            }

            btn.disabled = true;
            btn.classList.add('hidden');
            loading.classList.remove('hidden');
            log("Đang gửi file lên server...");

            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('model', modelSelect.value);
                formData.append('mode', modeSelect.value);

                const response = await fetch(`${API_URL}/api/convert`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || "Lỗi chuyển đổi");
                }

                const data = await response.json();
                
                if (data.success) {
                    currentMarkdown = data.result;
                    
                    document.getElementById('result-text').value = currentMarkdown;
                    updatePreview();
                    
                    document.getElementById('download-btn').classList.remove('hidden');
                    document.getElementById('copy-btn').classList.remove('hidden');
                    log("Chuyển đổi thành công!");
                } else {
                    throw new Error("Không có kết quả trả về");
                }

            } catch (error) {
                alert("Lỗi: " + error.message);
                log("Lỗi: " + error.message);
            } finally {
                loading.classList.add('hidden');
                btn.classList.remove('hidden');
                btn.disabled = false;
            }
        }

        async function handleDownloadDocx() {
            if (!currentMarkdown) {
                alert("Không có nội dung để xuất!");
                return;
            }
            
            const btn = document.getElementById('download-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo...';
            btn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('markdown_text', currentMarkdown);

                log("Đang gửi yêu cầu xuất Word...");
                const response = await fetch(`${API_URL}/api/export-docx`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMsg = "Lỗi tạo file Word";
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMsg = errorData.detail || errorMsg;
                    } catch (e) {
                        errorMsg = errorText || errorMsg;
                    }
                    throw new Error(errorMsg);
                }

                const blob = await response.blob();
                
                if (blob.size === 0) {
                    throw new Error("File Word rỗng, có thể do lỗi xử lý");
                }
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "Ket_qua_HT_MATH.docx";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                log("Đã tải file Word thành công!");

            } catch (e) {
                const errorMsg = e.message || "Lỗi không xác định";
                alert("Lỗi xuất Word: " + errorMsg);
                log("Lỗi xuất Word: " + errorMsg);
                console.error("Export Word error:", e);
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        function copyToClipboard() {
            if (!currentMarkdown) return;
            navigator.clipboard.writeText(currentMarkdown).then(() => {
                alert("Đã copy nội dung Markdown!");
            });
        }

        // --- PASTE IMAGE & DRAG & DROP ---
        
        // Cho phép chỉnh sửa textarea và tự động cập nhật preview
        document.addEventListener('DOMContentLoaded', () => {
            const textarea = document.getElementById('result-text');
            const previewDiv = document.getElementById('result-preview');
            
            if (textarea) {
                textarea.addEventListener('input', () => {
                    currentMarkdown = textarea.value;
                    updatePreview();
                });
                
                // Paste image vào textarea
                textarea.addEventListener('paste', async (event) => {
                    const items = event.clipboardData.items;
                    for (let i = 0; i < items.length; i++) {
                        const item = items[i];
                        if (item.type.indexOf('image') !== -1) {
                            event.preventDefault();
                            event.stopPropagation();
                            const blob = item.getAsFile();
                            if (blob) {
                                await handlePastedImage(blob);
                            }
                            return;
                        }
                    }
                });
            }
            
            // Paste image vào preview area
            if (previewDiv) {
                previewDiv.addEventListener('paste', async (event) => {
                    const items = event.clipboardData.items;
                    for (let i = 0; i < items.length; i++) {
                        const item = items[i];
                        if (item.type.indexOf('image') !== -1) {
                            event.preventDefault();
                            event.stopPropagation();
                            const blob = item.getAsFile();
                            if (blob) {
                                await handlePastedImage(blob);
                            }
                            return;
                        }
                    }
                });
            }
            
            // Paste image toàn cục (khi focus vào bất kỳ đâu)
            document.addEventListener('paste', async (event) => {
                // Chỉ xử lý nếu không có element nào khác đang xử lý
                if (event.target.tagName === 'TEXTAREA' || event.target.id === 'result-preview') {
                    return; // Đã được xử lý bởi event listener riêng
                }
                
                const items = event.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (item.type.indexOf('image') !== -1) {
                        event.preventDefault();
                        const blob = item.getAsFile();
                        if (blob) {
                            await handlePastedImage(blob);
                        }
                        break;
                    }
                }
            });
        });

        function updatePreview() {
            const previewDiv = document.getElementById('result-preview');
            if (!previewDiv) return;
            
            if (currentMarkdown && currentMarkdown.trim()) {
                previewDiv.innerHTML = marked.parse(currentMarkdown);
                const placeholder = document.getElementById('preview-placeholder');
                if (placeholder) placeholder.style.display = 'none';
                
                if (window.MathJax) {
                    MathJax.typesetPromise([previewDiv]).catch((err) => {
                        console.log('MathJax error:', err);
                    });
                }
            } else {
                const placeholder = document.getElementById('preview-placeholder');
                if (placeholder) placeholder.style.display = 'block';
            }
        }

        async function handlePastedImage(blob) {
            if (!blob) {
                log("Không có ảnh để xử lý");
                return;
            }
            
            log("Đang xử lý ảnh đã dán...");
            
            // Hiển thị loading
            const loadingDiv = document.getElementById('loading');
            const convertBtn = document.getElementById('convert-btn');
            if (loadingDiv) loadingDiv.classList.remove('hidden');
            if (convertBtn) {
                convertBtn.disabled = true;
                convertBtn.classList.add('hidden');
            }
            
            try {
                const formData = new FormData();
                formData.append('file', blob, 'pasted-image.png');
                formData.append('model', document.getElementById('model-select').value);
                formData.append('mode', document.getElementById('mode-select').value);

                const response = await fetch(`${API_URL}/api/convert`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({ detail: "Lỗi không xác định" }));
                    throw new Error(errData.detail || "Lỗi chuyển đổi ảnh");
                }

                const data = await response.json();
                
                if (data.success) {
                    // Nối kết quả vào markdown hiện tại (tại vị trí con trỏ nếu có)
                    const textarea = document.getElementById('result-text');
                    const existingText = textarea.value;
                    const cursorPos = textarea.selectionStart || existingText.length;
                    
                    // Chèn vào vị trí con trỏ hoặc cuối cùng
                    const beforeText = existingText.substring(0, cursorPos);
                    const afterText = existingText.substring(cursorPos);
                    const separator = (beforeText && afterText) ? '\n\n' : (beforeText || afterText) ? '\n\n' : '';
                    const newText = beforeText + separator + data.result + (afterText ? '\n\n' + afterText : '');
                    
                    currentMarkdown = newText;
                    textarea.value = currentMarkdown;
                    
                    // Đặt lại vị trí con trỏ
                    const newCursorPos = cursorPos + separator.length + data.result.length;
                    textarea.setSelectionRange(newCursorPos, newCursorPos);
                    textarea.focus();
                    
                    updatePreview();
                    
                    document.getElementById('download-btn').classList.remove('hidden');
                    document.getElementById('copy-btn').classList.remove('hidden');
                    log("Đã xử lý ảnh đã dán thành công!");
                } else {
                    throw new Error("Không có kết quả trả về");
                }

            } catch (error) {
                alert("Lỗi xử lý ảnh: " + error.message);
                log("Lỗi: " + error.message);
                console.error("Paste image error:", error);
            } finally {
                if (loadingDiv) loadingDiv.classList.add('hidden');
                if (convertBtn) {
                    convertBtn.disabled = false;
                    convertBtn.classList.remove('hidden');
                }
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.style.backgroundColor = '#f0f9ff';
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.style.backgroundColor = '';
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    handlePastedImage(file);
                } else if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
                    // Xử lý PDF được kéo thả
                    const fileInput = document.getElementById('file-upload');
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    document.getElementById('file-name').innerText = file.name;
                    document.getElementById('file-name').classList.remove('hidden');
                    handleConvert();
                }
            }
        }

        function handlePaste(event) {
            // Xử lý paste trong preview area
            const items = event.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf('image') !== -1) {
                    event.preventDefault();
                    const blob = item.getAsFile();
                    handlePastedImage(blob);
                    break;
                }
            }
        }
    </script>
</body>
</html>

